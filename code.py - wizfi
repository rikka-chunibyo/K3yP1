import time
import board
import busio
import digitalio
from adafruit_wizfiatcontrol import adafruit_wizfiatcontrol

# Wi-Fi AP Configuration
SSID = "PicoHID_Network"
PASSWORD = "testest"
CHANNEL = 3  # Wi-Fi Channel (1-11)
SECURITY = 3  # 0: Open, 1: WEP, 2: WPA, 3: WPA2-Personal
HIDDEN = 1  # 1 = Hidden SSID, 0 = Visible

# WizFi360 Pins
RX = board.GP5
TX = board.GP4
resetpin = digitalio.DigitalInOut(board.GP20)
rtspin = False

# Setup UART for WizFi360
uart = busio.UART(TX, RX, baudrate=115200, receiver_buffer_size=2048)

print("Initializing WizFi360...")
wizfi = adafruit_wizfiatcontrol.WizFi_ATcontrol(
    uart, 115200, reset_pin=resetpin, rts_pin=rtspin, debug=True
)

print("Resetting WizFi360...")
wizfi.hard_reset()

# Function to send AT commands manually via UART
def send_at_command(command, delay=1):
    """ Sends an AT command via UART and waits for a response """
    print(f"Sending: {command}")
    uart.write((command + "\r\n").encode())  # Send command
    time.sleep(delay)  # Wait for WizFi360 to process

# Set WizFi360 to Access Point Mode
send_at_command("AT+CWMODE=2", delay=2)  # AP Mode

# Start Hidden Access Point
ap_command = f'AT+CWSAP="{SSID}","{PASSWORD}",{CHANNEL},{SECURITY},4,{HIDDEN}'
send_at_command(ap_command, delay=3)

print(f"Hidden AP '{SSID}' should now be active!")

# Keep running to prevent script exit
while True:
    time.sleep(10)
