import getch
import socket
import time

PICO_IP = "192.168.36.30"  # Change if needed
PORT = 12345
sock = None  # Declare socket globally

def connect():
    """Try to establish a TCP connection to the Pico."""
    global sock
    while True:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)  # Prevents long blocking
            sock.connect((PICO_IP, PORT))
            print(f"Connected to {PICO_IP}:{PORT}")
            return
        except Exception as e:
            print(f"Failed to connect: {e}, retrying in 2s...")
            time.sleep(2)

connect()  # Establish initial connection

def send_key(keycode):
    """Send a keycode to the Pico via TCP."""
    global sock
    try:
        sock.sendall(f"{keycode}\n".encode())  # Send keycode as raw data
    except Exception as e:
        print(f"Error sending keycode {keycode}: {e}")
        sock.close()
        sock = None
        connect()  # Reconnect if broken

print("Keylogger started!")

while True:
    try:
        char = getch.getch()
        keycode = ord(char)
        print(f"Sending keycode {keycode} to {PICO_IP}:{PORT}")
        send_key(keycode)
    except KeyboardInterrupt:
        print("Exiting...")
        break
    except Exception as e:
        print(f"Error: {e}")
        time.sleep(0.1)

sock.close()
