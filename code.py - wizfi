import board
import busio
import digitalio
import usb_hid
import wiznet5k
from wiznet5k import server
from adafruit_hid.keyboard import Keyboard
from adafruit_hid.keycode import Keycode

# Set up SPI for WizFi360
spi = busio.SPI(board.GP10, board.GP11, board.GP12)  # Adjust pins as needed
cs = digitalio.DigitalInOut(board.GP13)
reset = digitalio.DigitalInOut(board.GP14)

# Initialize WizFi360
eth = wiznet5k.WIZNET5K(spi, cs, reset)

# Configure WizFi360 as an Access Point
eth.start_ap("PicoHID_Network", "testest")  # Replace with desired SSID and password

# Start a web server on port 80
web_server = server.WIZServer(80)

# Initialize HID keyboard
keyboard = Keyboard(usb_hid.devices)

# Key mapping
key_map = {
    10: Keycode.ENTER,
    13: Keycode.ENTER,
    127: Keycode.BACKSPACE,
    9: Keycode.TAB,
    27: Keycode.ESCAPE,
    32: Keycode.SPACE,
}

while True:
    client = web_server.accept()
    if client:
        request = client.recv(1024).decode()
        print("Received request:", request)
        
        if "key?code=" in request:
            try:
                keycode = int(request.split("key?code=")[1].split()[0])
                if keycode in key_map:
                    keyboard.send(key_map[keycode])
                    response = "Key Sent"
                else:
                    response = "Invalid Keycode"
            except Exception as e:
                response = f"Error: {str(e)}"
        else:
            response = "Invalid Request"
        
        client.send("HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\n\r\n" + response)
        client.close()
